---
title: "2018 heat emission from EnergyPlus simulation at census tract level"
author: "Yujie Xu"
date: "8/15/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "~/Dropbox/workLBNL/EESA/code/im3-wrf/")
```

## Diurnal Profile

```{r helpers, message=FALSE}
library("dplyr")
library("tmap")

get.spatial.path.suf <- function(spatial.level) {
  if (spatial.level == "coarse") {
    spatial.path = "M02_EnergyPlus_Forcing_Historical_LowRes/meta"
    spatial.suf = ""
  } else if (spatial.level == "finer") {
    spatial.path = "high res grid for reporting"
    spatial.suf = "_finer"
  } else if (spatial.level == "tract") {
    spatial.path = "domain/tl_2018_06_tract"
    ## spatial.path = "domain"
    spatial.suf = "_tract"
  }
  list(spatial.path, spatial.suf)
}
```

The following shows the daily heat emission profile of a typical summer day and a typical winter day

```{r typicalDayProfile, message=FALSE}
time.pref = "annual_2018"
result = get.spatial.path.suf("tract")
spatial.path = result[[1]]
spatial.suf = result[[2]]

get.file.list <- function(date.str, time.pref, spatial.suf) {
  files = list.files(sprintf("aggregated_heat/%s%s", time.pref, spatial.suf), sprintf("^%s  ", date.str))
}

summer.weekend.day = "07_07"
summer.week.day = "07_11"
winter.weekend.day = "01_13"
winter.week.day = "01_17"

files <- lapply(c(summer.weekend.day, summer.week.day, winter.weekend.day, winter.week.day), function(day) {
  get.file.list(day, time.pref, spatial.suf)
}) %>%
  unlist()

summer.winter.data <- lapply(files, function(f) {
  df <- readr::read_csv(sprintf("aggregated_heat/%s%s/%s", time.pref, spatial.suf, f), col_types = readr::cols())
  df
}) %>%
  dplyr::bind_rows()

to.plot.daily <- summer.winter.data %>%
  tidyr::separate(`Date/Time`, into = c("Date", "Hour"), sep = "  ") %>%
  dplyr::mutate(Hour = as.integer(gsub(":00:00", "", Hour)) - 1) %>%
  dplyr::mutate(day.status = ifelse(Date %in% gsub("_", "/", c(summer.week.day, winter.week.day)), "weekday", "weekend")) %>%
  dplyr::mutate(season.status = ifelse(Date %in% gsub("_", "/", c(summer.week.day, summer.weekend.day)), "summer", "winter")) %>%
  ## convert unit from J to kWh
  dplyr::mutate(value = value * 1e-9 * 277.778) %>%
  {.}

to.plot.daily.total <- to.plot.daily %>%
  dplyr::group_by(Date, day.status, season.status, Hour, id) %>%
  dplyr::summarise(value = sum(value)) %>%
  dplyr::ungroup()
```


The following are the definition of heat emission components.

```{r variableDef}
tibble::tibble(
          `variable` = c("emission.exfiltration", "emission.exhaust", "emission.ref", "emission.rej", "emission.surf"),
          `EnergyPlus output` = c(
            "Environment:Site Total Zone Exfiltration Heat Loss \\[J](Hourly)"
          , "Environment:Site Total Zone Exhaust Air Heat Loss \\[J](Hourly)"
          , "SimHVAC:Air System Relief Air Total Heat Loss Energy \\[J](Hourly)"
          , "SimHVAC:HVAC System Total Heat Rejection Energy \\[J](Hourly)",
            "Environment:Site Total Surface Heat Emission to Air \\[J](Hourly)")
        ) %>%
  knitr::kable(format="html") %>%
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

The following shows the daily heat emission in the original scale. We can see a lot of large outliers. This indicates a large variability across different census tracts.

```{r plotDaily, message=FALSE, fig.width=15}
to.plot.daily.total %>%
  dplyr::mutate(Hour = factor(Hour)) %>%
  ggplot2::ggplot(ggplot2::aes(Hour, value)) +
  ggplot2::geom_boxplot(outlier.size = 0.5) +
  ggplot2::facet_grid(season.status~day.status) +
  ggplot2::ggtitle("Total heat emission daily profile for typical summer and winter days") +
  ggplot2::ylab("Heat Emission (kWh)") +
  ggplot2::theme()
```

The following plot zooms in to the non-outlier part of the boxplot above. We can see the total heat emission peaks around noon time.
```{r plotDailyZoom, message=FALSE, fig.width=15}
to.plot.daily.total %>%
  dplyr::mutate(Hour = factor(Hour)) %>%
  ggplot2::ggplot(ggplot2::aes(Hour, value)) +
  ggplot2::geom_boxplot(outlier.shape = NA) +
  ggplot2::coord_cartesian(ylim = c(-500, 13000)) +
  ggplot2::facet_grid(season.status~day.status) +
  ggplot2::ggtitle("Total heat emission daily profile for typical summer and winter days") +
  ggplot2::ylab("Heat Emission (kWh)") +
  ggplot2::theme()
```

The following plot shows the daily heat emission by different component and time of day for a typical summer day (7/15) and a typical winter day (1/15). Surface heat emission is dominating and is much larger than other components
```{r plotDailyComp, message=FALSE, fig.width=15}
to.plot.daily %>%
  dplyr::mutate(Hour = factor(Hour)) %>%
  dplyr::mutate(day.label = paste0(season.status, " ", day.status)) %>%
  ggplot2::ggplot(ggplot2::aes(Hour, value)) +
  ggplot2::geom_boxplot(outlier.shape = NA) +
  ggplot2::coord_cartesian(ylim = c(-500, 11000)) +
  ggplot2::facet_grid(variable~day.label) +
  ggplot2::ggtitle("Heat emission component daily profile for typical summer and winter days") +
  ggplot2::ylab("Heat Emission (kWh)") +
  ggplot2::theme()
```

The following plots the non-surface heat emission components.
```{r plotDailyCompNonSurf, message=FALSE, fig.width=15}
to.plot.daily %>%
  dplyr::mutate(Hour = factor(Hour)) %>%
  dplyr::mutate(day.label = paste0(season.status, " ", day.status)) %>%
  dplyr::filter(variable != "emission.surf") %>%
  ggplot2::ggplot(ggplot2::aes(Hour, value)) +
  ggplot2::geom_boxplot(outlier.size = 0.5) +
  ggplot2::facet_grid(variable~day.label) +
  ggplot2::ggtitle("Total heat emission daily profile for a summer day and a winter day") +
  ggplot2::ylab("Heat Emission (kWh)") +
  ggplot2::theme()
```

Zooming in to the non-outlier parts. Among the non-surface heat emissions, HVAC rejection heat is the largest. Different from surface heat emission, the HVAC emission peaks around 3pm in the afternoon and lingers around much longer.
```{r plotDailyCompNonSurfZoom, message=FALSE, fig.width=15}
to.plot.daily %>%
  dplyr::mutate(Hour = factor(Hour)) %>%
  dplyr::mutate(day.label = paste0(season.status, " ", day.status)) %>%
  dplyr::filter(variable != "emission.surf") %>%
  ggplot2::ggplot(ggplot2::aes(Hour, value)) +
  ggplot2::geom_boxplot(outlier.shape = NA) +
  ggplot2::coord_cartesian(ylim = c(-50, 2300)) +
  ggplot2::facet_grid(variable~day.label) +
  ggplot2::ggtitle("Total heat emission daily profile for a summer day and a winter day") +
  ggplot2::ylab("Heat Emission (kWh)") +
  ggplot2::theme()
```

## Diurnal profile for different months

Each data point in the following plot is the heat emission of a grid cell (or
census tract) during a specific hour of day, averaged across a particular month.
It compares the diurnal profile of the total heat emission and several heat emission sources.

```{r hourlyAvgPerMonth, message=FALSE, fig.width=15, fig.height=10}
df.hourly.avg.month.component <- readr::read_csv(sprintf("aggregated_heat/%s%s_hourly_avg_month.csv", time.pref, spatial.suf)) %>%
  ## convert unit from J to kWh
  dplyr::mutate(value = value * 1e-9 * 277.778) %>%
  {.}

df.hourly.avg.month <- df.hourly.avg.month.component %>%
  dplyr::group_by(month, Hour, id) %>%
  dplyr::summarise(value = sum(value)) %>%
  dplyr::ungroup() %>%
  {.}

df.hourly.avg.month %>%
  dplyr::mutate_at(vars(month, Hour), as.numeric) %>%
  ggplot2::ggplot(ggplot2::aes(x=Hour, y=value, group=interaction(month, Hour))) +
  ggplot2::geom_boxplot(outlier.size = 0.5) +
  ggplot2::facet_wrap(.~month) +
  ggplot2::theme()

```

The following plot shows the hourly average heat emission for each heat emission component and for each month
```{r hourlyAvgPerMonthComp, message=FALSE, fig.width=15, fig.height=8}
df.hourly.avg.month.component %>%
  dplyr::mutate_at(vars(month, Hour), as.numeric) %>%
  ggplot2::ggplot(ggplot2::aes(x=Hour, y=value, group=interaction(month, Hour))) +
  ggplot2::geom_boxplot(outlier.size = 0.5) +
  ggplot2::facet_grid(variable~month) +
  ggplot2::theme()
```

The following zooms in to the non-outlier part.
```{r hourlyAvgPerMonthCompZoom, message=FALSE, fig.width=15, fig.height=8}
df.hourly.avg.month.component %>%
  dplyr::mutate_at(vars(month, Hour), as.numeric) %>%
  ggplot2::ggplot(ggplot2::aes(x=Hour, y=value, group=interaction(month, Hour))) +
  ggplot2::geom_boxplot(outlier.shape = NA) +
  ggplot2::facet_grid(variable~month) +
  ggplot2::coord_cartesian(ylim = c(-1000, 10000)) +
  ggplot2::theme()
```

The following plot shows the average hourly heat emission further averaged across different grids or census tracts
```{r hourlyAvgPerMonthSpace, message=FALSE, fig.width=15}

to.plot.hr.avg.total <- df.hourly.avg.month %>%
  dplyr::group_by(month, Hour) %>%
  dplyr::summarise(value = mean(value)) %>%
  dplyr::ungroup() %>%
  {.}

label.hr = 13
df.label <- to.plot.hr.avg.total %>%
  dplyr::filter(Hour == label.hr) %>%
  {.}

to.plot.hr.avg.total %>%
  ggplot2::ggplot() +
  ggplot2::geom_point(ggplot2::aes(x=Hour, y=value, color=month)) +
  ggplot2::geom_line(ggplot2::aes(x=Hour, y=value, color=month)) +
  ggrepel::geom_label_repel(ggplot2::aes(x=label.hr, y=value, label=month), data=df.label) +
  ggplot2::theme()

```

The following plot shows the average hourly heat emission of each component further averaged across different grids or census tracts
```{r hourAvgPerMonthCompSpace, message=FALSE, fig.width=15}
to.plot.hr.avg.component <- df.hourly.avg.month.component %>%
  dplyr::group_by(month, Hour, variable) %>%
  dplyr::summarise(value = mean(value)) %>%
  dplyr::ungroup() %>%
  {.}

to.plot.hr.avg.component %>%
  ggplot2::ggplot() +
  ggplot2::geom_point(ggplot2::aes(x=Hour, y=value, color=variable), size=0.5) +
  ggplot2::geom_line(ggplot2::aes(x=Hour, y=value, color=variable)) +
  ## ggrepel::geom_label_repel(ggplot2::aes(x=label.hr, y=value, label=month), data=df.label.component) +
  ggplot2::facet_wrap(.~month) +
  ggplot2::theme()
```
## Spatial distribution

The following plot shows the total heat emission across grid cells at 2pm and 10pm for summer and winter and for weekday and weekend.

```{r spatialTotal, message=FALSE, fig.width=15, fig.height = 10}
result = get.spatial.path.suf("tract")
spatial.path = result[[1]]
spatial.suf = result[[2]]

grid.geo <- sf::st_read(sprintf("%s/tl_2018_06_tract.shp", spatial.path)) %>%
  dplyr::filter(COUNTYFP=="037") %>%
  dplyr::select(GEOID) %>%
  dplyr::rename(id = GEOID) %>%
  {.}

la.boundary = sf::st_read("domain/la-county-boundary.geojson")
la.boundary.valid = sf::st_make_valid(la.boundary)

to.plot.snapshot.total <- to.plot.daily.total %>%
  dplyr::filter(Hour %in% c(14, 22)) %>%
  dplyr::mutate(time.label = sprintf("%s %s %02d:00", season.status, day.status, Hour)) %>%
  dplyr::rename(emission.kwh = value) %>%
  {.}

to.plot.snapshot.total.spatial <- to.plot.snapshot.total %>%
  dplyr::left_join(grid.geo, by="id") %>%
  sf::st_as_sf() %>%
  {.}

tm_shape(to.plot.snapshot.total.spatial) +
  tm_polygons(col="emission.kwh", n=8, style="quantile", midpoint=0, palette="seq", border.alpha = 0) +
  tm_facets(by="time.label", ncol=4) +
  tm_layout(main.title = "Heat emission at different time snapshots",
            legend.position=c("left", "bottom"), legend.outside=FALSE,
            aes.palette = list(seq = "-RdYlGn")) +
  tm_shape(la.boundary.valid) +
  tm_polygons("CITY", alpha=0, legend.show=FALSE)
```

The following shows the surface component
```{r spatialComponentsSurf, message=FALSE, fig.width=15, fig.height = 10}
to.plot.snapshot <- to.plot.daily %>%
  dplyr::filter(Hour %in% c(14, 22)) %>%
  dplyr::mutate(time.label = sprintf("%s %s %02d:00", season.status, day.status, Hour)) %>%
  dplyr::rename(emission.kwh = value) %>%
  {.}

to.plot.snapshot.surf <- to.plot.daily %>%
  dplyr::filter(Hour %in% c(14, 22)) %>%
  dplyr::filter(variable == "emission.surf") %>%
  dplyr::mutate(time.label = sprintf("%s %s %02d:00", season.status, day.status, Hour)) %>%
  dplyr::rename(emission.kwh = value) %>%
  {.}

to.plot.snapshot.surf.spatial <- to.plot.snapshot.surf %>%
  dplyr::left_join(grid.geo, by="id") %>%
  sf::st_as_sf() %>%
  {.}

tm_shape(to.plot.snapshot.surf.spatial) +
  tm_polygons(col="emission.kwh", n=8, style="quantile", midpoint=0, palette = "seq", border.alpha = 0) +
  tm_facets(by="time.label", ncol=4) +
  tm_layout(main.title = "Building surface heat emission at different time snapshots",
            legend.position=c("left", "bottom"), legend.outside=FALSE,
            aes.palette = list(seq = "-RdYlGn")) +
  tm_shape(la.boundary.valid) +
  tm_polygons("CITY", alpha=0, legend.show=FALSE)
```

The following plot shows the HVAC rejection component. HVAC rejection have less day-night difference than building surface heat rejection.
```{r spatialComponentRej, message=FALSE, fig.width=15, fig.height = 10}
to.plot.snapshot.rej <- to.plot.daily %>%
  dplyr::filter(Hour %in% c(14, 22)) %>%
  dplyr::filter(variable == "emission.rej") %>%
  dplyr::mutate(time.label = sprintf("%s %s %02d:00", season.status, day.status, Hour)) %>%
  dplyr::rename(emission.kwh = value) %>%
  {.}

to.plot.snapshot.rej.spatial <- to.plot.snapshot.rej %>%
  dplyr::left_join(grid.geo, by="id") %>%
  sf::st_as_sf() %>%
  {.}

tm_shape(to.plot.snapshot.rej.spatial) +
  tm_polygons(col="emission.kwh", n=8, style="quantile", midpoint=0, palette = "seq", border.alpha = 0) +
  tm_facets(by="time.label", ncol=4) +
  tm_layout(main.title = "HVAC rejection heat emission at different time snapshots",
            legend.position=c("left", "bottom"), legend.outside=FALSE,
            aes.palette = list(seq = "-RdYlGn")) +
  tm_shape(la.boundary.valid) +
  tm_polygons("CITY", alpha=0, legend.show=FALSE)
```
